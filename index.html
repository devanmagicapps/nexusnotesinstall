<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Meta tag diperbarui untuk menonaktifkan zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Notes</title>

    <!-- PWA Tags for Android -->
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Nexus Notes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus Notes">

    <!-- Link to Manifest and Service Worker Registration -->
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* [ARSITEKTUR UI BARU DENGAN FLOATING FRAME] */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        #app {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: relative;
        }

        #app-content {
            height: 100%;
            width: 100%;
        }

        /* Custom scrollbar untuk tampilan dark/minimalis */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .secret-panel-container ::-webkit-scrollbar-track { background: #0f172a; }
        .light-theme ::-webkit-scrollbar-track { background: #e5e7eb; }
        .light-theme ::-webkit-scrollbar-thumb { background: #9ca3af; }

        /* Filter untuk mengubah ikon hitam menjadi putih di mode gelap */
        .dark-icon-filter {
            filter: invert(100%) sepia(0%) saturate(7500%) hue-rotate(180deg) brightness(105%) contrast(101%);
        }

        /* Animasi untuk notifikasi floating */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 4s ease-in-out forwards;
        }

        /* Class untuk mencegah seleksi teks */
        .no-select {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ and Edge */
            user-select: none; /* Standard syntax */
        }
    </style>
</head>
<body class="bg-white">

    <div id="app">
        <div id="app-content">
            <!-- Konten aplikasi utama akan dirender di sini -->
            <div class="flex items-center justify-center h-full">
                <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
        <!-- Kontainer untuk modal bantuan -->
        <div id="modal-container"></div>
        <!-- Kontainer untuk notifikasi floating -->
        <div id="status-container" class="absolute bottom-0 left-0 right-0 p-4 z-50 pointer-events-none"></div>
    </div>

    <!-- Firebase CDN Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Atur level log Firestore
        setLogLevel('Debug');

        // --- DEFINISI IKON (menggunakan URL Icons8) ---
        const Icons = {
            Plus: `<img src="https://img.icons8.com/ios-glyphs/30/plus-math.png" alt="New Note" class="w-6 h-6 dark-icon-filter"/>`,
            Save: `<img src="https://img.icons8.com/material-outlined/30/save.png" alt="Save" class="w-6 h-6 dark-icon-filter"/>`,
            Trash2: `<img src="https://img.icons8.com/ios-glyphs/30/trash.png" alt="Delete" class="w-6 h-6"/>`,
            ArrowLeft: `<img src="https://img.icons8.com/ios-glyphs/30/left.png" alt="Back" class="w-6 h-6"/>`,
            Loader2: `<img src="https://img.icons8.com/ios-glyphs/30/loading-circle.png" alt="Loading" class="w-6 h-6 dark-icon-filter"/>`,
            Lock: `<img src="https://img.icons8.com/ios-glyphs/30/lock.png" alt="Lock" class="w-5 h-5 dark-icon-filter"/>`,
            Unlock: `<img src="https://img.icons8.com/ios-glyphs/30/unlock.png" alt="Unlock" class="w-5 h-5 dark-icon-filter"/>`,
            Settings: `<img src="https://img.icons8.com/ios-glyphs/30/settings.png" alt="Settings" class="w-5 h-5 dark-icon-filter"/>`,
            Zap: `<img src="https://img.icons8.com/ios-glyphs/30/flash-on.png" alt="Mode" class="w-5 h-5 dark-icon-filter"/>`,
            Edit: `<img src="https://img.icons8.com/ios-glyphs/30/edit.png" alt="Edit" class="w-5 h-5 dark-icon-filter"/>`,
            Hash: `<img src="https://img.icons8.com/ios-glyphs/30/hashtag.png" alt="ID" class="w-5 h-5 dark-icon-filter"/>`,
            Check: `<img src="https://img.icons8.com/ios-glyphs/30/checked-2.png" alt="Check ID" class="w-5 h-5 dark-icon-filter"/>`
        };

        // --- KONFIGURASI FIREBASE ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC6iE-MTA8trrP418d_V8bDt4bC9Arrrvk",
            authDomain: "nexus-note.firebaseapp.com",
            projectId: "nexus-note",
            storageBucket: "nexus-note.firebasestorage.app",
            messagingSenderId: "56226763793",
            appId: "1:56226763793:web:80f8f1230aefbc04bf4db0"
        };
        
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(USER_FIREBASE_CONFIG);
        const firebaseConfig = JSON.parse(firebaseConfigStr);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let unsubscribeListener = null;

        // --- KONSTANTA GLOBAL OFFLINE ---
        const STORAGE_KEY = 'minimalist_offline_notes';
        const SECRET_KEYWORD_KEY = 'app_secret_keyword'; 
        const APP_MODE_KEY = 'app_current_mode';
        const PEEK_SUB_MODE_KEY = 'app_peek_sub_mode';
        const START_ITEMS_LIST_KEY = 'app_start_items';
        const END_ITEMS_LIST_KEY = 'app_end_items';
        const CUSTOM_ID_KEY = 'app_custom_id'; 
        const NOTES_SWITCH_TITLE_KEY = 'app_notes_switch_title';
        const PEEK_TITLE_KEY = 'app_peek_title';
        
        const DEFAULT_START_ITEMS_20 = ["Koin", "Tisu", "Kunci", "Pensil", "Penghapus", "Jarum", "Gelas", "Batu", "Klip", "Benang", "Cap", "Topi", "Botol", "Daun", "Tanah", "Sisir", "Sekrup", "Kartu", "Obeng", "Kancing"];
        const DEFAULT_END_ITEMS_19 = ["Gelang", "Magnet", "Peniti", "Sandal", "Lampu", "Kabel", "Payung", "Buku", "Pulpen", "Meja", "Kursi", "Pintu", "Jendela", "Sepatu", "Rokok", "Korek", "Kertas", "Amplop", "Gunting"];
        const DEFAULT_TRICK_TITLE = "List benda random";

        // --- GLOBAL STATE ---
        let appState = {
            notes: [],
            activeNoteId: null,
            title: '',
            content: '',
            isLoading: true,
            isSaving: false,
            secretKeyword: 'KUNCI',
            appMode: 'Notes Switch',
            peekSubMode: 'Hold to Peek',
            startItemsList: DEFAULT_START_ITEMS_20,
            endItemsList: DEFAULT_END_ITEMS_19,
            customId: '',
            notesSwitchTitle: DEFAULT_TRICK_TITLE,
            peekTitle: DEFAULT_TRICK_TITLE,
            rememberedItem: null,
            typeToPeekItem: null,
            typeToPeekIndex: 0,
            isListening: false,
            statusMessage: null, 
            longPressTimeout: null,
            originalTrickTitle: '',
            showHelpModal: false,
        };

        // --- FUNGSI UTILITY LOCAL STORAGE & UMUM ---
        const getLocalNotes = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) { console.error("Gagal memuat catatan dari Local Storage:", e); return []; }
        };

        const saveLocalNotes = (notes) => {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(notes)); } catch (e) { console.error("Gagal menyimpan catatan ke Local Storage:", e); }
        };

        const getSecretKeyword = () => localStorage.getItem(SECRET_KEYWORD_KEY) || 'KUNCI';
        const saveSecretKeyword = (keyword) => localStorage.setItem(SECRET_KEYWORD_KEY, keyword.toUpperCase().trim());
        
        const getNotesSwitchTitle = () => localStorage.getItem(NOTES_SWITCH_TITLE_KEY) || DEFAULT_TRICK_TITLE;
        const saveNotesSwitchTitle = (title) => localStorage.setItem(NOTES_SWITCH_TITLE_KEY, title.trim());

        const getPeekTitle = () => localStorage.getItem(PEEK_TITLE_KEY) || DEFAULT_TRICK_TITLE;
        const savePeekTitle = (title) => localStorage.setItem(PEEK_TITLE_KEY, title.trim());

        const getCustomId = () => localStorage.getItem(CUSTOM_ID_KEY) || '';
        const saveCustomId = (id) => localStorage.setItem(CUSTOM_ID_KEY, id.trim());

        const getAppMode = () => localStorage.getItem(APP_MODE_KEY) || 'Notes Switch';
        const saveAppMode = (mode) => localStorage.setItem(APP_MODE_KEY, mode);

        const getPeekSubMode = () => localStorage.getItem(PEEK_SUB_MODE_KEY) || 'Hold to Peek';
        const savePeekSubMode = (mode) => localStorage.setItem(PEEK_SUB_MODE_KEY, mode);
        
        const getItemsList = (key, defaultList) => {
            try {
                const stored = localStorage.getItem(key);
                const parsed = stored ? JSON.parse(stored) : null;
                return Array.isArray(parsed) && parsed.length > 0 ? parsed : defaultList; 
            } catch (e) { console.error(`Gagal memuat daftar dari ${key}:`, e); return defaultList; }
        };

        const saveItemsList = (key, list) => localStorage.setItem(key, JSON.stringify(list));
        const sortNotes = (notesArray) => [...notesArray].sort((a, b) => b.updatedAt - a.updatedAt);
        const isMatchingSecretKeyword = (title, keyword) => (title && keyword) ? title.toUpperCase().trim() === keyword.toUpperCase().trim() : false;
        
        const generateRandomListContent = (itemsList, isPeekMode = false) => {
            if (!itemsList || itemsList.length === 0) return "ERROR: Daftar item tidak boleh kosong.";
            let listToDisplay = [...itemsList];
            if (isPeekMode) return listToDisplay.map((item, index) => `${index + 1}. ${item}`).join('\n');
            return listToDisplay.join('\n');
        };

        const initializeDiceDocument = async (id, showSuccess = false) => {
            if (!db || !/^\d{4}$/.test(id)) return;
            const docRef = doc(db, `dice/${id}`);
            try {
                await setDoc(docRef, { currentDiceNumber: 1, initializedAt: Date.now() }, { merge: false });
                if (showSuccess) showStatus(`ID Unik ${id} berhasil dibuat dan diaktifkan!`, false);
            } catch (e) { console.error("Gagal membuat dokumen Firestore dice:", e); showStatus(`Gagal membuat ID: ${e.message}`, true); }
        };

        const isIdActiveOnFirebase = async (id) => {
            if (!db || !/^\d{4}$/.test(id)) return false;
            const docRef = doc(db, `dice/${id}`);
            try { return (await getDoc(docRef)).exists(); } catch (e) { console.error("Gagal memeriksa status ID di Firebase:", e); return false; }
        };

        // --- STATE MANAGEMENT DAN RENDER UTAMA ---
        const setState = (newState) => {
            Object.assign(appState, newState);
            renderApp();
        };

        const showStatus = (message, isError = false) => {
            setState({ statusMessage: { message, isError } });
            setTimeout(() => setState({ statusMessage: null }), 3900); 
        };
        
        const handleLiveInput = (key, value) => {
            appState[key] = value; 
            if (key === 'title') {
                const trimmedTitle = value.trim().toUpperCase();
                if (trimmedTitle === appState.secretKeyword) {
                    checkSecretTitleTrigger(trimmedTitle);
                } else if (value.trim().toLowerCase() === 'help' && appState.activeNoteId === 'new') {
                    showHelpModal();
                }
            }
        };

        const checkSecretTitleTrigger = (secretTitle) => {
            const existingSecretNote = appState.notes.find(n => isMatchingSecretKeyword(n.title, secretTitle));
            if (existingSecretNote) {
                setState({ activeNoteId: existingSecretNote.id, title: existingSecretNote.title, content: existingSecretNote.content });
            } else {
                const newNoteId = Date.now().toString();
                const newSecretNote = { id: newNoteId, title: secretTitle, content: '', createdAt: Date.now(), updatedAt: Date.now() };
                const updatedNotes = [newSecretNote, ...appState.notes.filter(note => note.id !== appState.activeNoteId)];
                saveLocalNotes(updatedNotes);
                setState({ notes: updatedNotes, activeNoteId: newNoteId, title: newSecretNote.title, content: newSecretNote.content });
            }
        };

        // --- HANDLER MODAL BANTUAN ---
        const showHelpModal = () => setState({ showHelpModal: true });
        const hideHelpModal = () => {
            const shouldClear = appState.activeNoteId === 'new' && appState.title.trim().toLowerCase() === 'help';
            setState({ showHelpModal: false, ...(shouldClear && { activeNoteId: null, title: '', content: '' }) });
        };

        // --- HANDLER UTAMA ---
        const handleOpenNote = (note) => setState({ activeNoteId: note.id, title: note.title, content: note.content });
        const handleBackToList = () => setState({ activeNoteId: null, title: '', content: '' });
        
        const handleNewNote = () => {
            setState({ activeNoteId: 'new', title: '', content: '', typeToPeekIndex: 0 });
        };

        const handleSaveNote = () => {
            const titleEditor = document.getElementById('title-editor');
            const contentEditor = document.getElementById('content-editor');
            const noteTitle = (titleEditor?.value.trim() || appState.title.trim()) || 'Catatan Tanpa Judul';
            const noteContent = contentEditor?.value || appState.content;

            if (!noteTitle && !noteContent) { handleBackToList(); return; }

            setState({ isSaving: true });
            const timestamp = Date.now();
            let updatedNotes;
            let newNoteId = appState.activeNoteId;

            if (appState.activeNoteId && appState.activeNoteId !== 'new') {
                updatedNotes = appState.notes.map(note => note.id === appState.activeNoteId ? { ...note, title: noteTitle, content: noteContent, updatedAt: timestamp } : note);
            } else {
                newNoteId = timestamp.toString();
                updatedNotes = [{ id: newNoteId, title: noteTitle, content: noteContent, createdAt: timestamp, updatedAt: timestamp }, ...appState.notes];
            }
            
            const finalNotes = sortNotes(updatedNotes);
            saveLocalNotes(finalNotes);
            setState({ notes: finalNotes, isSaving: false, activeNoteId: isMatchingSecretKeyword(noteTitle, appState.secretKeyword) ? newNoteId : appState.activeNoteId });
            
            if (!isMatchingSecretKeyword(noteTitle, appState.secretKeyword)) { handleBackToList(); }
        };

        const handleDeleteNote = () => {
            if (!appState.activeNoteId || appState.activeNoteId === 'new') return;
            const updatedNotes = appState.notes.filter(note => note.id !== appState.activeNoteId);
            saveLocalNotes(updatedNotes);
            setState({ notes: updatedNotes });
            handleBackToList();
        };

        const handleNotesSwitchTrigger = () => {
            document.getElementById('content-editor')?.blur();
            if (appState.appMode !== 'Notes Switch' || appState.title !== appState.notesSwitchTitle) return;
            const expectedInitialContent = generateRandomListContent(appState.startItemsList);
            if (appState.content.trim() === expectedInitialContent.trim() && appState.endItemsList.length > 0) {
                const newContent = generateRandomListContent(appState.endItemsList);
                setState({ content: newContent });
            }
        };
        
        const longPressDuration = 500;
        const triggerPeek = () => {
            document.getElementById('content-editor')?.blur();
            const titleEditor = document.getElementById('title-editor');
            if (titleEditor) titleEditor.value = appState.rememberedItem || "Menunggu Item...";
        };
        const startLongPress = () => {
            if (appState.appMode !== 'Peek' || appState.peekSubMode !== 'Hold to Peek' || appState.title !== appState.peekTitle) return;
            appState.originalTrickTitle = document.getElementById('title-editor')?.value || '';
            appState.longPressTimeout = setTimeout(triggerPeek, longPressDuration);
        };
        const cancelLongPress = () => {
            clearTimeout(appState.longPressTimeout);
            const titleEditor = document.getElementById('title-editor');
            if (titleEditor && appState.originalTrickTitle) {
                titleEditor.value = appState.originalTrickTitle;
                appState.originalTrickTitle = '';
            }
        };

        const handleTypeToPeek = (event) => {
            const { appMode, peekSubMode, activeNoteId, typeToPeekItem } = appState;
            if (appMode !== 'Peek' || peekSubMode !== 'Type to Peek' || activeNoteId !== 'new' || !typeToPeekItem) return;

            event.preventDefault();
            
            let index = appState.typeToPeekIndex;
            if (index < typeToPeekItem.length) {
                const editor = event.target;
                const revealedPart = typeToPeekItem.substring(0, index + 1);
                editor.value = revealedPart;
                appState.content = editor.value;
                appState.typeToPeekIndex = index + 1;
            }
        };
        
        // --- LOGIKA PENGATURAN ---
        const syncTrickNotes = () => {
            const { appMode, notesSwitchTitle, peekTitle } = appState;
            let allNotes = getLocalNotes();
            let nonTrickNotes = allNotes.filter(n => n.id !== 'trick_note_NotesSwitch' && n.id !== 'trick_note_Peek');
            let trickNote = null;

            if (appMode === 'Notes Switch') {
                trickNote = { id: 'trick_note_NotesSwitch', title: notesSwitchTitle, content: generateRandomListContent(appState.startItemsList), createdAt: Date.now(), updatedAt: Date.now() };
            } else if (appMode === 'Peek') {
                trickNote = { id: 'trick_note_Peek', title: peekTitle, content: generateRandomListContent(appState.startItemsList, true), createdAt: Date.now(), updatedAt: Date.now() };
            }

            const finalNotes = sortNotes(trickNote ? [...nonTrickNotes, trickNote] : nonTrickNotes);
            saveLocalNotes(finalNotes);
            appState.notes = finalNotes;
        };
        
        const handleSettingUpdate = (key, value, saveFunction, successMessage) => {
            const trimmedValue = value.trim();
            if (!trimmedValue || trimmedValue === appState[key]) return;
            saveFunction(trimmedValue);
            setState({ [key]: trimmedValue });
            if(key.includes('Title')) syncTrickNotes();
            showStatus(successMessage, false);
        };
        
        const handleCustomIdUpdate = async (customIdInput) => {
            const trimmedId = customIdInput.trim();
            if (!/^\d{4}$/.test(trimmedId)) {
                showStatus("Custom ID harus 4 digit angka!", true); return;
            }
            if (trimmedId === appState.customId) return;

            const docRef = doc(db, `dice/${trimmedId}`);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                showStatus(`ID ${trimmedId} sudah digunakan.`, true); return;
            }

            saveCustomId(trimmedId);
            setState({ customId: trimmedId });
            await initializeDiceDocument(trimmedId, true);
            setupPeekListener();
        };

        const handleItemsListUpdate = (listType, inputString) => {
            const newItems = inputString.split('\n').map(item => item.trim()).filter(Boolean);
            if (newItems.length === 0) {
                showStatus("Daftar tidak boleh kosong!", true); return;
            }
            if (appState.appMode === 'Peek' && newItems.length > 20) {
                 showStatus("Daftar Peek maksimal 20 item!", true); return;
            }

            const key = listType === 'start' ? START_ITEMS_LIST_KEY : END_ITEMS_LIST_KEY;
            const stateKey = listType === 'start' ? 'startItemsList' : 'endItemsList';
            saveItemsList(key, newItems);
            setState({ [stateKey]: newItems });
            
            syncTrickNotes();
            showStatus(`Daftar ${listType === 'start' ? 'Awal' : 'Akhir'} diperbarui.`, false);
            setState({});
        };
        
        const handleModeChange = async (newMode) => {
            if (newMode === 'Peek') {
                if (appState.customId.length !== 4) {
                    showStatus("Mode Peek memerlukan Custom ID 4 digit.", true);
                    renderApp(); return;
                }
                if (!(await isIdActiveOnFirebase(appState.customId))) {
                    showStatus("ID Kustom tidak aktif. Mode tidak bisa dialihkan.", true);
                    renderApp(); return;
                }
            }
            saveAppMode(newMode);
            setState({ appMode: newMode });
            syncTrickNotes();
            setupPeekListener();
            showStatus(`Mode diubah ke: ${newMode}`, false);
        };
        
        const handlePeekSubModeChange = (newMode) => {
            savePeekSubMode(newMode);
            setState({ peekSubMode: newMode });
            showStatus(`Sub-mode Peek diubah ke: ${newMode}`, false);
        };

        // --- RENDER FUNCTIONS ---
        const renderNoteList = () => {
            const displayNotes = appState.notes.filter(note => !isMatchingSecretKeyword(note.title, appState.secretKeyword));
            return `
                <div class="flex flex-col h-full bg-white light-theme">
                    <header class="flex-shrink-0 sticky top-0 z-10 p-4 bg-white/80 backdrop-blur-md border-b border-gray-200">
                        <h1 class="text-3xl font-bold text-black">Daftar Catatan</h1>
                    </header>
                    <div class="flex-grow overflow-y-auto space-y-3 p-4 pb-24">
                        ${displayNotes.length === 0 ? `<p class="text-gray-500 text-center mt-10">Belum ada catatan.</p>` : 
                        displayNotes.map((note) => `
                            <div id="note-${note.id}" class="bg-white p-4 rounded-xl shadow-md cursor-pointer transition duration-200 border-l-4 border-indigo-400 note-item"
                                onclick="window.handleOpenNote({ id: '${note.id}', title: \`${note.title.replace(/`/g, '\\`')}\`, content: \`${note.content.replace(/`/g, '\\`')}\` })">
                                <h2 class="text-lg font-semibold truncate text-black">${note.title || 'Catatan Tanpa Judul'}</h2>
                                <p class="text-sm text-gray-500 mt-1">${note.content ? (note.content.substring(0, 150).replace(/\n/g, ' ') + (note.content.length > 150 ? '...' : '')) : '...'}</p>
                                <span class="text-xs text-gray-400 mt-2 block">
                                    Diperbarui: ${new Date(note.updatedAt || Date.now()).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' })}
                                </span>
                            </div>`).join('')}
                    </div>
                    <button onclick="window.handleNewNote()" class="fixed bottom-6 right-6 p-4 bg-indigo-500 text-white rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 z-20">
                        ${Icons.Plus.replace('dark-icon-filter', '')}
                    </button>
                </div>`;
        };
        
        const renderNoteEditor = () => {
            const isNotesSwitchNote = appState.appMode === 'Notes Switch' && appState.title === appState.notesSwitchTitle;
            const isPeekNote = appState.appMode === 'Peek' && appState.title === appState.peekTitle;
            const isTrickNoteActive = isNotesSwitchNote || isPeekNote;

            let extraAttributes = '';
            if (isNotesSwitchNote) extraAttributes = `onclick="window.handleNotesSwitchTrigger()"`;
            else if (isPeekNote && appState.peekSubMode === 'Hold to Peek') {
                extraAttributes = `onmousedown="window.startLongPress()" onmouseup="window.cancelLongPress()" onmouseleave="window.cancelLongPress()" ontouchstart="window.startLongPress()" ontouchend="window.cancelLongPress()" ontouchcancel="window.cancelLongPress()"`;
            }

            return `
                <div class="flex flex-col h-full bg-white light-theme">
                    <header class="flex-shrink-0 sticky top-0 z-10 flex justify-between items-center p-4 bg-white/80 backdrop-blur-md border-b border-gray-200">
                        <button onclick="window.handleBackToList()" class="p-2 text-gray-700 rounded-full hover:bg-gray-100">${Icons.ArrowLeft}</button>
                        <div class="flex space-x-2">
                            ${(appState.activeNoteId && appState.activeNoteId !== 'new' && !isTrickNoteActive) ? `<button onclick="window.handleDeleteNote()" class="p-2 text-red-500 rounded-full hover:bg-red-100">${Icons.Trash2}</button>` : ''}
                            <button onclick="window.handleSaveNote()" class="p-2 rounded-full text-white transition shadow-md ${appState.isSaving ? 'bg-gray-300' : 'bg-indigo-500 hover:bg-indigo-600'}">
                                ${appState.isSaving ? Icons.Loader2.replace('class="', 'class="animate-spin ') : Icons.Save.replace('dark-icon-filter', '')}
                            </button>
                        </div>
                    </header>
                    <div class="flex-grow flex flex-col overflow-y-auto p-4">
                        <input id="title-editor" type="text" value="${appState.title}" oninput="window.handleLiveInput('title', this.value)"
                            placeholder="Judul Catatan" class="flex-shrink-0 text-2xl font-semibold p-2 border-b-2 border-gray-100 mb-4 focus:border-indigo-500 outline-none w-full" ${isTrickNoteActive ? 'readonly' : ''} />
                        <textarea id="content-editor" oninput="window.handleLiveInput('content', this.value)" onkeydown="window.handleTypeToPeek(event)"
                            placeholder="Isi catatan..." class="flex-grow w-full p-2 text-gray-800 resize-none outline-none leading-relaxed text-lg"
                            ${extraAttributes} ${isTrickNoteActive || (appState.appMode === 'Peek' && appState.peekSubMode === 'Hold to Peek') ? 'readonly' : ''}>${appState.content}</textarea>
                    </div>
                </div>`;
        };

        const renderSecretSettingsPanel = () => {
            const { appMode, peekSubMode, secretKeyword, customId, notesSwitchTitle, peekTitle, startItemsList, endItemsList } = appState;
            
            let modeSpecificSettings = '';
            if (appMode === 'Notes Switch') {
                modeSpecificSettings = `
                    <div>
                        <p class="text-sm font-light text-gray-400 mb-2">Judul Mode Notes Switch:</p>
                        <input type="text" value="${notesSwitchTitle}" class="w-full bg-gray-700 p-3 rounded-lg" 
                            onblur="handleSettingUpdate('notesSwitchTitle', this.value, saveNotesSwitchTitle, 'Judul Notes Switch diperbarui.')">
                    </div>`;
            } else if (appMode === 'Peek') {
                modeSpecificSettings = `
                    <div>
                        <p class="text-sm font-light text-gray-400 mb-2">Judul Mode Peek:</p>
                        <input type="text" value="${peekTitle}" class="w-full bg-gray-700 p-3 rounded-lg"
                            onblur="handleSettingUpdate('peekTitle', this.value, savePeekTitle, 'Judul Peek diperbarui.')">
                    </div>
                    <div class="mt-4">
                         <p class="text-sm font-light text-gray-400 mb-2">Sub-mode Peek:</p>
                         <div class="flex flex-wrap gap-2">${['Hold to Peek', 'Type to Peek'].map(mode => `<label class="flex items-center cursor-pointer p-2 bg-gray-600 rounded-lg ${peekSubMode === mode ? 'ring-2 ring-red-500' : ''}"><input type="radio" name="peekSubMode" value="${mode}" ${peekSubMode === mode ? 'checked' : ''} onchange="handlePeekSubModeChange(this.value)" class="mr-2"><span>${mode}</span></label>`).join('')}</div>
                    </div>`;
            }

            return `
                <div class="flex flex-col h-full bg-gray-900 text-white p-4 font-sans secret-panel-container">
                    <header class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3"><button onclick="handleBackToList()" class="p-2 rounded-full hover:bg-gray-800">${Icons.ArrowLeft.replace('class="', 'class="dark-icon-filter ')}</button><h1 class="text-xl font-mono tracking-widest text-red-500">${Icons.Settings} PENGATURAN</h1><div class="w-10"></div></header>
                    <div class="flex-grow overflow-y-auto space-y-6 pb-6">
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl space-y-4">
                            <h2 class="text-lg font-bold text-indigo-400">${Icons.Unlock} Akses Rahasia</h2>
                            <div><p class="text-sm text-gray-400 mb-2">Kata Kunci:</p><input type="text" value="${secretKeyword}" class="w-full bg-gray-700 p-3 rounded-lg font-mono uppercase" onblur="handleSettingUpdate('secretKeyword', this.value.toUpperCase(), saveSecretKeyword, 'Kata Kunci diperbarui.')"></div>
                            <div><p class="text-sm text-gray-400 mb-2">Custom ID (4 Digit):</p><input type="text" value="${customId}" class="w-24 bg-gray-700 p-3 rounded-lg font-mono" onblur="handleCustomIdUpdate(this.value)" maxlength="4"></div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl">
                            <h2 class="text-lg font-bold text-indigo-400 mb-3">${Icons.Zap} Mode Operasi</h2>
                            <div class="flex flex-wrap gap-2">${['Notes Switch', 'Peek', 'Normal'].map(mode => `<label class="flex items-center cursor-pointer p-2 bg-gray-700 rounded-lg ${appMode === mode ? 'ring-2 ring-red-500' : ''}"><input type="radio" name="appMode" value="${mode}" ${appMode === mode ? 'checked' : ''} onchange="handleModeChange(this.value)" class="mr-2"><span>${mode}</span></label>`).join('')}</div>
                            <div class="mt-6 space-y-4">${modeSpecificSettings ? `<h3 class="text-md font-semibold text-red-300">Kustomisasi Mode Aktif</h3>${modeSpecificSettings}` : ''}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl">
                           <h2 class="text-lg font-bold text-indigo-400 mb-2">${Icons.Edit} Kustomisasi Daftar</h2>
                           <textarea id="start-list-input" rows="8" class="bg-gray-700 text-gray-200 p-3 rounded-lg resize-none w-full font-mono text-sm">${startItemsList.join('\n')}</textarea>
                           <button onclick="handleItemsListUpdate('start', document.getElementById('start-list-input').value)" class="mt-3 p-2 w-full bg-indigo-500 rounded-lg">Simpan Daftar Awal</button>
                           ${appMode === 'Notes Switch' ? `<textarea id="end-list-input" rows="8" class="mt-4 bg-gray-700 text-gray-200 p-3 rounded-lg resize-none w-full font-mono text-sm">${endItemsList.join('\n')}</textarea><button onclick="handleItemsListUpdate('end', document.getElementById('end-list-input').value)" class="mt-3 p-2 w-full bg-indigo-500 rounded-lg">Simpan Daftar Akhir</button>` : ''}
                        </div>
                    </div>
                </div>`;
        };
        
        const renderHelpModal = () => !appState.showHelpModal ? '' : `<div id="help-modal-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="hideHelpModal()"><div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-sm w-full text-gray-800" onclick="event.stopPropagation()"><h2 class="text-2xl font-bold mb-4 text-indigo-600">Informasi Bantuan</h2><p class="mb-4">Kata kunci panel rahsia Anda adalah:</p><div class="bg-gray-100 p-3 rounded-md"><p class="text-lg font-mono font-bold text-gray-900">${appState.secretKeyword}</p></div><button onclick="hideHelpModal()" class="mt-6 w-full bg-indigo-500 text-white py-2 rounded-lg">Tutup</button></div></div>`;
        
        // --- FIREBASE LISTENER ---
        const setupPeekListener = () => {
            if (unsubscribeListener) unsubscribeListener();
            if (appState.appMode !== 'Peek' || !db || !/^\d{4}$/.test(appState.customId)) return;

            unsubscribeListener = onSnapshot(doc(db, `dice/${appState.customId}`), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const diceNumber = docSnapshot.data()?.currentDiceNumber;
                    const itemIndex = diceNumber - 1;
                    const list = appState.startItemsList; 
                    if (itemIndex >= 0 && itemIndex < list.length) {
                        const newItem = list[itemIndex];
                        appState.rememberedItem = newItem;
                        appState.typeToPeekItem = newItem;
                        appState.typeToPeekIndex = 0;
                    }
                }
            });
        };

        // --- INIT APP ---
        const initApp = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch (e) { console.error("Gagal inisialisasi Firebase:", e); }

            Object.assign(appState, {
                secretKeyword: getSecretKeyword(), appMode: getAppMode(), peekSubMode: getPeekSubMode(),
                startItemsList: getItemsList(START_ITEMS_LIST_KEY, DEFAULT_START_ITEMS_20),
                endItemsList: getItemsList(END_ITEMS_LIST_KEY, DEFAULT_END_ITEMS_19),
                customId: getCustomId(), notesSwitchTitle: getNotesSwitchTitle(), peekTitle: getPeekTitle(),
            });

            syncTrickNotes();
            setState({ isLoading: false, notes: sortNotes(getLocalNotes()) });
            setupPeekListener();
        };

        const renderApp = () => {
            const appContentDiv = document.getElementById('app-content');
            const modalContainer = document.getElementById('modal-container');
            const statusContainer = document.getElementById('status-container');
            
            if (!appContentDiv || !modalContainer || !statusContainer) return;
            if (appState.isLoading) return;
            
            const isSecretNote = appState.activeNoteId && isMatchingSecretKeyword(appState.title, appState.secretKeyword);
            appContentDiv.innerHTML = appState.activeNoteId !== null ? (isSecretNote ? renderSecretSettingsPanel() : renderNoteEditor()) : renderNoteList();
            modalContainer.innerHTML = renderHelpModal();

            statusContainer.innerHTML = ''; 
            if (appState.statusMessage) {
                const { message, isError } = appState.statusMessage;
                const statusElement = document.createElement('div');
                statusElement.className = `pointer-events-auto max-w-md mx-auto rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'} text-white text-center py-3 px-4 animate-fade-in-out`;
                statusElement.textContent = message;
                statusContainer.appendChild(statusElement);
            }
            
            Object.assign(window, { handleOpenNote, handleBackToList, handleNewNote, handleSaveNote, handleDeleteNote, handleNotesSwitchTrigger, handleModeChange, handlePeekSubModeChange, handleLiveInput, startLongPress, cancelLongPress, handleTypeToPeek, handleSettingUpdate, handleCustomIdUpdate, handleItemsListUpdate, hideHelpModal });
        };

        window.addEventListener('load', () => {
            setTimeout(initApp, 300);
        });

    </script>
</body>
</html>