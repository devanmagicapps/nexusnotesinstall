<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Meta tag diperbarui untuk menonaktifkan zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Notes</title>

    <!-- PWA Tags for Android -->
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Nexus Notes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus Notes">

    <!-- Link to Manifest and Service Worker Registration -->
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter secara global */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overscroll-behavior: none; /* Mencegah pull-to-refresh */
        }
        /* Style untuk memastikan body mengisi seluruh viewport */
        html, body, #app {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Mencegah scroll di level body */
        }
        /* Custom scrollbar untuk tampilan dark/minimalis */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .secret-panel-container ::-webkit-scrollbar-track { background: #0f172a; }
        .light-theme ::-webkit-scrollbar-track { background: #e5e7eb; }
        .light-theme ::-webkit-scrollbar-thumb { background: #9ca3af; }

        /* Filter untuk mengubah ikon hitam menjadi putih di mode gelap */
        .dark-icon-filter {
            filter: invert(100%) sepia(0%) saturate(7500%) hue-rotate(180deg) brightness(105%) contrast(101%);
        }

        /* Animasi untuk notifikasi floating */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 4s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-white">

    <div id="app" class="h-screen w-screen relative">
        <div id="app-content" class="h-full w-full">
            <!-- Konten loading awal dikembalikan ke versi SVG -->
            <div class="flex items-center justify-center h-full">
                <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
        <!-- Kontainer untuk notifikasi floating -->
        <div id="status-container" class="absolute bottom-0 left-0 right-0 p-4 z-50 pointer-events-none"></div>
    </div>

    <!-- Firebase CDN Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Atur level log Firestore
        setLogLevel('Debug');

        // --- DEFINISI IKON (menggunakan URL Icons8) ---
        const Icons = {
            Plus: `<img src="https://img.icons8.com/ios-glyphs/30/plus-math.png" alt="New Note" class="w-6 h-6 dark-icon-filter"/>`,
            Save: `<img src="https://img.icons8.com/material-outlined/30/save.png" alt="Save" class="w-6 h-6 dark-icon-filter"/>`,
            Trash2: `<img src="https://img.icons8.com/ios-glyphs/30/trash.png" alt="Delete" class="w-6 h-6"/>`,
            ArrowLeft: `<img src="https://img.icons8.com/ios-glyphs/30/left.png" alt="Back" class="w-6 h-6"/>`,
            Loader2: `<img src="https://img.icons8.com/ios-glyphs/30/loading-circle.png" alt="Loading" class="w-6 h-6 dark-icon-filter"/>`,
            Lock: `<img src="https://img.icons8.com/ios-glyphs/30/lock.png" alt="Lock" class="w-5 h-5 dark-icon-filter"/>`,
            Unlock: `<img src="https://img.icons8.com/ios-glyphs/30/unlock.png" alt="Unlock" class="w-5 h-5 dark-icon-filter"/>`,
            Settings: `<img src="https://img.icons8.com/ios-glyphs/30/settings.png" alt="Settings" class="w-5 h-5 dark-icon-filter"/>`,
            Zap: `<img src="https://img.icons8.com/ios-glyphs/30/flash-on.png" alt="Mode" class="w-5 h-5 dark-icon-filter"/>`,
            Edit: `<img src="https://img.icons8.com/ios-glyphs/30/edit.png" alt="Edit" class="w-5 h-5 dark-icon-filter"/>`,
            Hash: `<img src="https://img.icons8.com/ios-glyphs/30/hashtag.png" alt="ID" class="w-5 h-5 dark-icon-filter"/>`,
            Check: `<img src="https://img.icons8.com/ios-glyphs/30/checked-2.png" alt="Check ID" class="w-5 h-5 dark-icon-filter"/>`
        };

        // --- KONFIGURASI FIREBASE ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC6iE-MTA8trrP418d_V8bDt4bC9Arrrvk",
            authDomain: "nexus-note.firebaseapp.com",
            projectId: "nexus-note",
            storageBucket: "nexus-note.firebasestorage.app",
            messagingSenderId: "56226763793",
            appId: "1:56226763793:web:80f8f1230aefbc04bf4db0"
        };
        
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(USER_FIREBASE_CONFIG);
        const firebaseConfig = JSON.parse(firebaseConfigStr);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let unsubscribeListener = null;

        // --- KONSTANTA GLOBAL OFFLINE ---
        const STORAGE_KEY = 'minimalist_offline_notes';
        const SECRET_KEYWORD_KEY = 'app_secret_keyword'; 
        const APP_MODE_KEY = 'app_current_mode';
        const START_ITEMS_LIST_KEY = 'app_start_items';
        const END_ITEMS_LIST_KEY = 'app_end_items';
        const CUSTOM_ID_KEY = 'app_custom_id'; 
        
        const DEFAULT_START_ITEMS_20 = ["Koin", "Tisu", "Kunci", "Pensil", "Penghapus", "Jarum", "Gelas", "Batu", "Klip", "Benang", "Cap", "Topi", "Botol", "Daun", "Tanah", "Sisir", "Sekrup", "Kartu", "Obeng", "Kancing"];
        const DEFAULT_END_ITEMS_19 = ["Gelang", "Magnet", "Peniti", "Sandal", "Lampu", "Kabel", "Payung", "Buku", "Pulpen", "Meja", "Kursi", "Pintu", "Jendela", "Sepatu", "Rokok", "Korek", "Kertas", "Amplop", "Gunting"];

        // --- GLOBAL STATE ---
        let appState = {
            notes: [],
            activeNoteId: null,
            title: '',
            content: '',
            isLoading: true,
            isSaving: false,
            secretKeyword: 'KUNCI',
            appMode: 'Hallucination',
            startItemsList: DEFAULT_START_ITEMS_20,
            endItemsList: DEFAULT_END_ITEMS_19,
            customId: '',
            hallucinationNoteTitle: 'List Benda Acak',
            mindReadingNoteTitle: 'Clipboard Cepat',
            rememberedItem: null,
            isListening: false,
            statusMessage: null, 
            longPressTimeout: null,
            originalTrickTitle: '',
        };

        // --- FUNGSI UTILITY LOCAL STORAGE & UMUM (DIADOPSI DARI CONTOH) ---
        const getLocalNotes = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Gagal memuat catatan dari Local Storage:", e);
                return [];
            }
        };

        const saveLocalNotes = (notes) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
            } catch (e) {
                console.error("Gagal menyimpan catatan ke Local Storage:", e);
            }
        };

        const getSecretKeyword = () => localStorage.getItem(SECRET_KEYWORD_KEY) || 'KUNCI';
        const saveSecretKeyword = (keyword) => localStorage.setItem(SECRET_KEYWORD_KEY, keyword.toUpperCase().trim());

        const getCustomId = () => localStorage.getItem(CUSTOM_ID_KEY) || '';
        const saveCustomId = (id) => localStorage.setItem(CUSTOM_ID_KEY, id.trim());

        const getAppMode = () => localStorage.getItem(APP_MODE_KEY) || 'Hallucination';
        const saveAppMode = (mode) => localStorage.setItem(APP_MODE_KEY, mode);
        
        const getItemsList = (key, defaultList) => {
            try {
                const stored = localStorage.getItem(key);
                const parsed = stored ? JSON.parse(stored) : null;
                return Array.isArray(parsed) && parsed.length > 0 ? parsed : defaultList; 
            } catch (e) {
                console.error(`Gagal memuat daftar dari ${key}:`, e);
                return defaultList;
            }
        };

        const saveItemsList = (key, list) => localStorage.setItem(key, JSON.stringify(list));

        const sortNotes = (notesArray) => [...notesArray].sort((a, b) => b.updatedAt - a.updatedAt);
        const isMatchingSecretKeyword = (title, keyword) => (title && keyword) ? title.toUpperCase().trim() === keyword.toUpperCase().trim() : false;
        
        const generateRandomListContent = (itemsList, isMindReading = false) => {
            if (!itemsList || itemsList.length === 0) return "ERROR: Daftar item tidak boleh kosong.";
            let listToDisplay = [...itemsList];
            if (isMindReading) return listToDisplay.map((item, index) => `${index + 1}. ${item}`).join('\n');
            return listToDisplay.join('\n');
        };

        const initializeDiceDocument = async (id, showSuccess = false) => {
            if (!db || !/^\d{4}$/.test(id)) return;
            const docRef = doc(db, `dice/${id}`);
            try {
                await setDoc(docRef, { currentDiceNumber: 1, initializedAt: Date.now() }, { merge: false });
                if (showSuccess) showStatus(`ID Unik ${id} berhasil dibuat dan diaktifkan!`, false);
            } catch (e) {
                console.error("Gagal membuat dokumen Firestore dice:", e);
                showStatus(`Gagal membuat ID: ${e.message}`, true);
            }
        };

        const isCustomIdUnique = async (id) => {
            if (!db || !/^\d{4}$/.test(id)) return false;
            const docRef = doc(db, `dice/${id}`);
            try {
                const docSnap = await getDoc(docRef);
                return !docSnap.exists();
            } catch (e) {
                console.error("Gagal memeriksa keunikan Custom ID:", e);
                return false; 
            }
        };

        const isIdActiveOnFirebase = async (id) => {
            if (!db || !/^\d{4}$/.test(id)) return false;
            const docRef = doc(db, `dice/${id}`);
            try {
                const docSnap = await getDoc(docRef);
                return docSnap.exists();
            } catch (e) {
                console.error("Gagal memeriksa status ID di Firebase:", e);
                return false; 
            }
        };

        // --- STATE MANAGEMENT DAN RENDER UTAMA ---
        const setState = (newState) => {
            Object.assign(appState, newState);
            renderApp();
        };

        const showStatus = (message, isError = false) => {
            setState({ statusMessage: { message, isError } });
            setTimeout(() => setState({ statusMessage: null }), 4000); 
        };
        
        const handleLiveInput = (key, value) => {
            appState[key] = value; 
            if (key === 'title') {
                const trimmedTitle = value.trim().toUpperCase();
                if (trimmedTitle === appState.secretKeyword) {
                    checkSecretTitleTrigger(trimmedTitle);
                }
            }
        };

        const checkSecretTitleTrigger = (secretTitle) => {
            const existingSecretNote = appState.notes.find(n => isMatchingSecretKeyword(n.title, secretTitle));
            const currentContentInEditor = document.getElementById('content-editor')?.value || appState.content;

            if (existingSecretNote) {
                setState({ activeNoteId: existingSecretNote.id, title: existingSecretNote.title, content: existingSecretNote.content, rememberedItem: null });
            } else {
                const newNoteId = Date.now().toString();
                const timestamp = Date.now();
                const newSecretNote = { id: newNoteId, title: secretTitle, content: currentContentInEditor, createdAt: timestamp, updatedAt: timestamp };
                let updatedNotes = [newSecretNote, ...appState.notes.filter(note => note.id !== appState.activeNoteId && !isMatchingSecretKeyword(note.title, secretTitle))];
                saveLocalNotes(updatedNotes);
                setState({ notes: updatedNotes, activeNoteId: newNoteId, title: newSecretNote.title, content: newSecretNote.content, rememberedItem: null });
            }
        };

        // --- HANDLER UTAMA ---
        const handleOpenNote = (note) => setState({ activeNoteId: note.id, title: note.title, content: note.content, rememberedItem: null });
        const handleBackToList = () => setState({ activeNoteId: null, title: '', content: '', rememberedItem: null });
        const handleNewNote = () => setState({ activeNoteId: 'new', title: '', content: '', rememberedItem: null });

        const handleSaveNote = (internalCall = false) => {
            if (appState.isSaving && !internalCall) return;
            
            const titleEditor = document.getElementById('title-editor');
            const contentEditor = document.getElementById('content-editor');
            if (titleEditor) appState.title = titleEditor.value;
            if (contentEditor) appState.content = contentEditor.value;

            const noteTitle = appState.title.trim() || 'Catatan Tanpa Judul';
            const noteContent = appState.content; 
            
            if (!noteTitle && !noteContent) {
                handleBackToList();
                return;
            }

            setState({ isSaving: true });
            const timestamp = Date.now();
            let updatedNotes;
            let newNoteId = appState.activeNoteId;
            const isSecretNoteBeingSaved = isMatchingSecretKeyword(noteTitle, appState.secretKeyword);
            let isNew = false;

            if (appState.activeNoteId && appState.activeNoteId !== 'new') {
                updatedNotes = appState.notes.map(note => note.id === appState.activeNoteId ? { ...note, title: noteTitle, content: noteContent, updatedAt: timestamp } : note);
            } else {
                isNew = true;
                newNoteId = timestamp.toString();
                const newNote = { id: newNoteId, title: noteTitle, content: noteContent, createdAt: timestamp, updatedAt: timestamp };
                updatedNotes = [newNote, ...appState.notes];
            }
            
            const finalNotes = sortNotes(updatedNotes);
            saveLocalNotes(finalNotes);
            setState({ notes: finalNotes, isSaving: false, activeNoteId: isNew ? newNoteId : appState.activeNoteId });
            
            if (!internalCall && !isSecretNoteBeingSaved) { 
                handleBackToList(); 
            }
        };

        const handleDeleteNote = () => {
            if (!appState.activeNoteId || appState.activeNoteId === 'new') return;
            const updatedNotes = appState.notes.filter(note => note.id !== appState.activeNoteId);
            saveLocalNotes(updatedNotes);
            setState({ notes: updatedNotes });
            handleBackToList();
        };

        const handleHallucinationTrigger = () => {
            document.getElementById('content-editor')?.blur();
            if (appState.appMode !== 'Hallucination' || appState.title !== appState.hallucinationNoteTitle) return;

            const expectedInitialContent = generateRandomListContent(appState.startItemsList, false);
            if (appState.content.trim() === expectedInitialContent.trim() && appState.endItemsList.length > 0) {
                const newContent = generateRandomListContent(appState.endItemsList, false); 
                appState.content = newContent;
                renderApp(); 
            }
        };
        
        const longPressDuration = 500;
        const triggerMindReading = () => {
            document.getElementById('content-editor')?.blur();
            const newTitle = appState.rememberedItem || "Menunggu Item...";
            const titleEditor = document.getElementById('title-editor');
            if(titleEditor) titleEditor.value = newTitle;
        };
        const startLongPress = () => {
            if (appState.appMode !== 'MindReading' || appState.title !== appState.mindReadingNoteTitle) return;
            const titleEditor = document.getElementById('title-editor');
            if (titleEditor) appState.originalTrickTitle = titleEditor.value;
            clearTimeout(appState.longPressTimeout);
            appState.longPressTimeout = setTimeout(triggerMindReading, longPressDuration);
        };
        const cancelLongPress = () => {
            clearTimeout(appState.longPressTimeout);
            const titleEditor = document.getElementById('title-editor');
            if (titleEditor && appState.originalTrickTitle) {
                titleEditor.value = appState.originalTrickTitle;
                appState.originalTrickTitle = '';
            }
        };
        
        // --- LOGIKA PENGATURAN BARU (DIADOPSI) ---
        const syncTrickNotes = () => {
            const { appMode, hallucinationNoteTitle, mindReadingNoteTitle } = appState;
            let allNotes = getLocalNotes();

            // Hapus catatan trik lama berdasarkan ID unik
            let nonTrickNotes = allNotes.filter(n => 
                n.id !== 'trick_note_Hallucination' && n.id !== 'trick_note_MindReading'
            );

            let trickNote = null;
            if (appMode === 'Hallucination') {
                const content = generateRandomListContent(appState.startItemsList, false);
                trickNote = { id: 'trick_note_Hallucination', title: hallucinationNoteTitle, content, createdAt: Date.now(), updatedAt: Date.now() };
            } else if (appMode === 'MindReading') {
                const content = generateRandomListContent(appState.startItemsList, true);
                trickNote = { id: 'trick_note_MindReading', title: mindReadingNoteTitle, content, createdAt: Date.now(), updatedAt: Date.now() };
            }

            const finalNotes = trickNote ? [...nonTrickNotes, trickNote] : nonTrickNotes;
            
            saveLocalNotes(finalNotes);
            appState.notes = sortNotes(finalNotes);
        };
        
        const handleKeywordUpdate = (newKeywordInput) => {
            const trimmedKeyword = newKeywordInput.trim().toUpperCase();
            if (!trimmedKeyword || trimmedKeyword === appState.secretKeyword) {
                showStatus("Kata kunci tidak valid atau sama!", true); return;
            }
            saveSecretKeyword(trimmedKeyword);
            
            // Perbarui judul catatan rahasia yang sedang aktif
            const updatedNotes = appState.notes.map(n => 
                n.id === appState.activeNoteId ? {...n, title: trimmedKeyword} : n
            );
            saveLocalNotes(updatedNotes);

            setState({ secretKeyword: trimmedKeyword, title: trimmedKeyword, notes: updatedNotes });
            showStatus("Kata Kunci Rahasia diperbarui.", false);
        };

        const handleCustomIdUpdate = async (customIdInput) => {
            const trimmedId = customIdInput.trim();
            if (!/^\d{4}$/.test(trimmedId)) {
                showStatus("Custom ID harus 4 digit angka!", true); return;
            }
            if (trimmedId === appState.customId) return;

            showStatus(`Memeriksa ID ${trimmedId}...`);
            const isUnique = await isCustomIdUnique(trimmedId);
            if (!isUnique) {
                showStatus(`ID ${trimmedId} sudah digunakan.`, true); return;
            }

            saveCustomId(trimmedId);
            setState({ customId: trimmedId });
            await initializeDiceDocument(trimmedId);
            showStatus(`Custom ID ${trimmedId} berhasil disimpan.`, false);
            setupMindReadingListener();
        };

        const handleItemsListUpdate = (listType, inputString) => {
            const newItems = inputString.split('\n').map(item => item.trim()).filter(Boolean);
            if (newItems.length === 0) {
                showStatus("Daftar tidak boleh kosong!", true); return;
            }
            if (appState.appMode === 'MindReading' && newItems.length > 20) {
                 showStatus("Daftar Mind Reading maksimal 20 item!", true); return;
            }

            if (listType === 'start') {
                saveItemsList(START_ITEMS_LIST_KEY, newItems);
                setState({ startItemsList: newItems });
            } else {
                saveItemsList(END_ITEMS_LIST_KEY, newItems);
                setState({ endItemsList: newItems });
            }
            
            syncTrickNotes();
            showStatus(`Daftar ${listType === 'start' ? 'Awal' : 'Akhir'} diperbarui.`, false);
            setState({}); // Trigger re-render
        };

        const handleModeChange = (newMode) => {
            if (newMode === 'MindReading' && appState.customId.length !== 4) {
                 showStatus("Mode Mind Reading memerlukan Custom ID 4 digit.", true);
                 renderApp(); // Re-render untuk mengembalikan pilihan radio
                 return;
            }
            saveAppMode(newMode);
            setState({ appMode: newMode });
            syncTrickNotes();
            setupMindReadingListener();
            showStatus(`Mode diubah ke: ${newMode}`, false);
        };


        // --- RENDER FUNCTIONS ---
        const renderNoteList = () => {
            const displayNotes = appState.notes.filter(note => !isMatchingSecretKeyword(note.title, appState.secretKeyword));
            const notesHtml = displayNotes.length === 0 ? `
                <p class="text-gray-500 text-center mt-10">Belum ada catatan. Tekan tombol '+' untuk membuat satu.</p>
            ` : displayNotes.map((note) => `
                <div 
                    id="note-${note.id}"
                    class="bg-white p-4 rounded-xl shadow-md cursor-pointer transition duration-200 border-l-4 border-indigo-400 note-item"
                    onclick="window.handleOpenNote({ id: '${note.id}', title: \`${note.title.replace(/`/g, '\\`')}\`, content: \`${note.content.replace(/`/g, '\\`')}\` })"
                >
                    <h2 class="text-lg font-semibold truncate text-black">${note.title || 'Catatan Tanpa Judul'}</h2>
                    <p class="text-sm text-gray-500 mt-1">${note.content ? (note.content.substring(0, 150).replace(/\n/g, ' ') + (note.content.length > 150 ? '...' : '')) : '...'}</p>
                    <span class="text-xs text-gray-400 mt-2 block">
                        Diperbarui: ${new Date(note.updatedAt || Date.now()).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' })}
                    </span>
                </div>
            `).join('');

            return `
                <div class="flex flex-col h-full bg-white p-4 light-theme">
                    <header class="mb-6 flex-shrink-0">
                        <h1 class="text-3xl font-bold text-black">Daftar Catatan</h1>
                    </header>
                    <div class="flex-grow overflow-y-auto space-y-3 pb-24">
                        ${notesHtml}
                    </div>
                    <button
                        onclick="window.handleNewNote()"
                        class="absolute bottom-6 right-6 p-4 bg-indigo-500 text-white rounded-full shadow-lg transition transform hover:scale-105 active:scale-95"
                    >
                        ${Icons.Plus.replace('dark-icon-filter', '')}
                    </button>
                </div>
            `;
        };
        
        const renderNoteEditor = () => {
            const isHallucinationNote = appState.appMode === 'Hallucination' && appState.title === appState.hallucinationNoteTitle;
            const isMindReadingNote = appState.appMode === 'MindReading' && appState.title === appState.mindReadingNoteTitle;
            const isTrickNoteActive = isHallucinationNote || isMindReadingNote;

            const deleteButton = (appState.activeNoteId && appState.activeNoteId !== 'new' && !isTrickNoteActive) ? `
                <button onclick="window.handleDeleteNote()" class="p-2 text-red-500 transition rounded-full hover:bg-red-100">${Icons.Trash2}</button>
            ` : '';
            const saveButtonClass = appState.isSaving ? 'bg-gray-300 cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600';

            let extraAttributes = '';
            if (isHallucinationNote) {
                extraAttributes = `onclick="window.handleHallucinationTrigger()"`;
            } else if (isMindReadingNote) {
                extraAttributes = `onmousedown="window.startLongPress(event)" onmouseup="window.cancelLongPress()" onmouseleave="window.cancelLongPress()" ontouchstart="window.startLongPress(event)" ontouchend="window.cancelLongPress()" ontouchcancel="window.cancelLongPress()"`;
            }

            return `
                <div class="flex flex-col h-full bg-white p-4 light-theme">
                    <header class="flex justify-between items-center mb-4 flex-shrink-0">
                        <button onclick="window.handleBackToList()" class="p-2 text-gray-700 transition rounded-full hover:bg-gray-100">${Icons.ArrowLeft}</button>
                        <div class="flex space-x-2">
                            ${deleteButton}
                            <button onclick="window.handleSaveNote(false)" ${appState.isSaving ? 'disabled' : ''} class="p-2 rounded-full text-white transition shadow-md ${saveButtonClass}">
                                ${appState.isSaving ? Icons.Loader2.replace('class="', 'class="animate-spin ') : Icons.Save.replace('dark-icon-filter', '')}
                            </button>
                        </div>
                    </header>
                    <input
                        id="title-editor" type="text" value="${appState.title}" oninput="window.handleLiveInput('title', this.value)"
                        placeholder="Judul Catatan" class="text-2xl font-semibold p-2 border-b-2 border-gray-100 mb-4 focus:border-indigo-500 outline-none w-full flex-shrink-0"
                        ${isTrickNoteActive ? 'readonly' : ''}
                    />
                    <textarea
                        id="content-editor" oninput="window.handleLiveInput('content', this.value)"
                        placeholder="Isi catatan Anda di sini..."
                        class="flex-grow w-full p-2 text-gray-800 resize-none outline-none leading-relaxed text-lg"
                        ${extraAttributes}
                        ${isMindReadingNote ? 'readonly' : ''}
                    >${appState.content}</textarea>
                </div>
            `;
        };

        const renderSecretSettingsPanel = () => {
            const { secretKeyword, customId, statusMessage, appMode, startItemsList, endItemsList, isSaving } = appState;
            
            const ItemListForm = (type, list) => `
                <div class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col mt-4">
                    <h3 class="text-md font-bold text-red-300 mb-2">Daftar ${type === 'start' ? 'Awal' : 'Akhir'}</h3>
                    <p class="text-xs font-light text-gray-400 mb-2">Total item: ${list.length}</p>
                    <textarea id="${type}-list-input" rows="8" class="bg-gray-800 text-gray-200 p-3 rounded-lg resize-none outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm">${list.join('\n')}</textarea>
                    <button onclick="handleItemsListUpdate('${type}', document.getElementById('${type}-list-input').value)" class="mt-3 p-2 bg-indigo-500 rounded-lg hover:bg-indigo-600">Simpan Daftar</button>
                </div>`;

            return `
                <div class="flex flex-col h-full bg-gray-900 text-white p-4 font-sans secret-panel-container">
                    <header class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3 flex-shrink-0">
                        <button onclick="handleBackToList()" class="p-2 text-gray-700 rounded-full hover:bg-gray-800">${Icons.ArrowLeft.replace('class="', 'class="dark-icon-filter ')}</button>
                        <h1 class="text-xl font-mono tracking-widest text-red-500 flex items-center">${Icons.Settings} PENGATURAN</h1>
                        <div class="w-10"></div>
                    </header>

                    <div class="flex-grow overflow-y-auto space-y-6 pb-6">
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl space-y-4">
                            <h2 class="text-lg font-bold text-indigo-400 flex items-center">${Icons.Unlock} Akses Rahasia</h2>
                            <div>
                                <p class="text-sm font-light text-gray-400 mb-2">Kata Kunci Panel:</p>
                                <div class="flex space-x-2"><input id="keyword-input" type="text" value="${secretKeyword}" class="flex-grow bg-gray-700 p-3 rounded-lg font-mono uppercase" onblur="handleKeywordUpdate(this.value)"></div>
                            </div>
                            <div>
                                <p class="text-sm font-light text-gray-400 mb-2">Custom ID Firebase (4 Digit):</p>
                                <div class="flex space-x-2 items-center"><input id="custom-id-input" type="text" value="${customId}" class="w-24 bg-gray-700 p-3 rounded-lg font-mono" onblur="handleCustomIdUpdate(this.value)" maxlength="4"><span class="text-sm text-gray-400">ID Aktif: ${customId || "None"}</span></div>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl">
                            <h2 class="text-lg font-bold text-indigo-400 mb-3 flex items-center">${Icons.Zap} Mode Operasi</h2>
                            <div class="flex flex-wrap gap-2">${['Hallucination', 'MindReading', 'Normal'].map(mode => `<label class="flex items-center cursor-pointer p-2 bg-gray-700 rounded-lg ${appMode === mode ? 'ring-2 ring-red-500' : ''}"><input type="radio" name="appMode" value="${mode}" ${appMode === mode ? 'checked' : ''} onchange="handleModeChange(this.value)" class="mr-2"><span>${mode}</span></label>`).join('')}</div>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl">
                           <h2 class="text-lg font-bold text-indigo-400 mb-2 flex items-center">${Icons.Edit} Kustomisasi Daftar</h2>
                           ${ItemListForm('start', startItemsList)}
                           ${appMode === 'Hallucination' ? ItemListForm('end', endItemsList) : ''}
                        </div>
                        
                    </div>
                </div>
            `;
        };

        
        // --- FIREBASE LISTENER ---
        const setupMindReadingListener = () => {
            if (unsubscribeListener) unsubscribeListener();
            unsubscribeListener = null;

            const { appMode, customId } = appState;
            if (appMode !== 'MindReading' || !db || !customId || !/^\d{4}$/.test(customId)) {
                setState({ isListening: false }); return; 
            }

            const docPath = `dice/${customId}`;
            setState({ isListening: true });

            unsubscribeListener = onSnapshot(doc(db, docPath), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const diceNumber = docSnapshot.data()?.currentDiceNumber;
                    if (typeof diceNumber !== 'number') return;
                    const itemIndex = diceNumber - 1;
                    const list = appState.startItemsList; 
                    if (itemIndex >= 0 && itemIndex < list.length) {
                        appState.rememberedItem = list[itemIndex];
                    } else {
                        appState.rememberedItem = `[Invalid]`;
                    }
                }
            }, (error) => {
                console.error("Firestore Error:", error);
                setState({ isListening: false });
            });
        };

        // --- INIT APP ---
        const initApp = async () => {
            try {
                if (!auth) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                }
            } catch (e) { console.error("Gagal inisialisasi Firebase:", e); }

            setState({
                secretKeyword: getSecretKeyword(),
                appMode: getAppMode(),
                startItemsList: getItemsList(START_ITEMS_LIST_KEY, DEFAULT_START_ITEMS_20),
                endItemsList: getItemsList(END_ITEMS_LIST_KEY, DEFAULT_END_ITEMS_19),
                customId: getCustomId(),
            });

            syncTrickNotes();
            
            setState({ isLoading: false });
            setupMindReadingListener();
        };

        const renderApp = () => {
            const appContentDiv = document.getElementById('app-content');
            if (!appContentDiv) return;
            const statusContainer = document.getElementById('status-container');
            
            if (appState.isLoading) {
                 appContentDiv.innerHTML = `<div class="flex items-center justify-center h-full"><svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;
                 return;
            }

            const isSecretNote = appState.activeNoteId && isMatchingSecretKeyword(appState.title, appState.secretKeyword);
            
            if (appState.activeNoteId !== null) {
                appContentDiv.innerHTML = isSecretNote ? renderSecretSettingsPanel() : renderNoteEditor();
            } else {
                appContentDiv.innerHTML = renderNoteList();
            }

            // Render status message
            if (statusContainer) {
                if (appState.statusMessage) {
                    const { message, isError } = appState.statusMessage;
                    statusContainer.innerHTML = `
                        <div class="pointer-events-auto max-w-md mx-auto rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'} text-white text-center py-3 px-4 animate-fade-in-out">
                            ${message}
                        </div>
                    `;
                } else {
                    statusContainer.innerHTML = '';
                }
            }
            
            // Expose Global functions
            window.handleOpenNote = handleOpenNote;
            window.handleBackToList = handleBackToList;
            window.handleNewNote = handleNewNote;
            window.handleSaveNote = handleSaveNote;
            window.handleDeleteNote = handleDeleteNote;
            window.handleHallucinationTrigger = handleHallucinationTrigger;
            window.handleModeChange = handleModeChange;
            window.handleLiveInput = handleLiveInput;
            window.startLongPress = startLongPress;
            window.cancelLongPress = cancelLongPress;
            window.handleKeywordUpdate = handleKeywordUpdate;
            window.handleCustomIdUpdate = handleCustomIdUpdate;
            window.handleItemsListUpdate = handleItemsListUpdate;
        };

        window.addEventListener('load', () => setTimeout(initApp, 300));

    </script>
</body>
</html>
