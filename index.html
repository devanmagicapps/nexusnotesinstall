<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Meta tag diperbarui untuk menonaktifkan zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Notes</title>

    <!-- PWA Tags for Android -->
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Nexus Notes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus Notes">

    <!-- Link to Manifest and Service Worker Registration -->
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter secara global */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overscroll-behavior: none; /* Mencegah pull-to-refresh */
        }
        /* Style untuk memastikan body mengisi seluruh viewport */
        html, body, #app {
            height: 100%;
            width: 100%;
            overflow: hidden; /* Mencegah scroll di level body */
        }
        /* Custom scrollbar untuk tampilan dark/minimalis */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .secret-panel-container ::-webkit-scrollbar-track { background: #0f172a; }
        .light-theme ::-webkit-scrollbar-track { background: #e5e7eb; }
        .light-theme ::-webkit-scrollbar-thumb { background: #9ca3af; }

        /* Filter untuk mengubah ikon hitam menjadi putih di mode gelap */
        .dark-icon-filter {
            filter: invert(100%) sepia(0%) saturate(7500%) hue-rotate(180deg) brightness(105%) contrast(101%);
        }
    </style>
</head>
<body class="bg-white">

    <div id="app" class="h-screen w-screen">
        <!-- Konten loading awal dikembalikan ke versi SVG -->
        <div class="flex items-center justify-center h-full">
            <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>

    <!-- Firebase CDN Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Atur level log Firestore
        setLogLevel('Debug');

        // --- DEFINISI IKON (menggunakan URL Icons8) ---
        const Icons = {
            Plus: `<img src="https://img.icons8.com/ios-glyphs/30/plus-math.png" alt="New Note" class="w-6 h-6 dark-icon-filter"/>`,
            Save: `<img src="https://img.icons8.com/material-outlined/30/save.png" alt="Save" class="w-6 h-6 dark-icon-filter"/>`,
            Trash2: `<img src="https://img.icons8.com/ios-glyphs/30/trash.png" alt="Delete" class="w-6 h-6"/>`,
            ArrowLeft: `<img src="https://img.icons8.com/ios-glyphs/30/left.png" alt="Back" class="w-6 h-6"/>`,
            Loader2: `<img src="https://img.icons8.com/ios-glyphs/30/loading-circle.png" alt="Loading" class="w-6 h-6 dark-icon-filter"/>`,
            Lock: `<img src="https://img.icons8.com/ios-glyphs/30/lock.png" alt="Lock" class="w-5 h-5 dark-icon-filter"/>`,
            Unlock: `<img src="https://img.icons8.com/ios-glyphs/30/unlock.png" alt="Unlock" class="w-5 h-5 dark-icon-filter"/>`,
            Settings: `<img src="https://img.icons8.com/ios-glyphs/30/settings.png" alt="Settings" class="w-5 h-5 dark-icon-filter"/>`,
            Zap: `<img src="https://img.icons8.com/ios-glyphs/30/flash-on.png" alt="Mode" class="w-5 h-5 dark-icon-filter"/>`,
            Edit: `<img src="https://img.icons8.com/ios-glyphs/30/edit.png" alt="Edit" class="w-5 h-5 dark-icon-filter"/>`,
            Hash: `<img src="https://img.icons8.com/ios-glyphs/30/hashtag.png" alt="ID" class="w-5 h-5 dark-icon-filter"/>`,
            Check: `<img src="https://img.icons8.com/ios-glyphs/30/checked-2.png" alt="Check ID" class="w-5 h-5 dark-icon-filter"/>`
        };

        // --- KONFIGURASI FIREBASE ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC6iE-MTA8trrP418d_V8bDt4bC9Arrrvk",
            authDomain: "nexus-note.firebaseapp.com",
            projectId: "nexus-note",
            storageBucket: "nexus-note.firebasestorage.app",
            messagingSenderId: "56226763793",
            appId: "1:56226763793:web:80f8f1230aefbc04bf4db0"
        };
        
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(USER_FIREBASE_CONFIG);
        const firebaseConfig = JSON.parse(firebaseConfigStr);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let unsubscribeListener = null;

        // --- KONSTANTA GLOBAL OFFLINE ---
        const STORAGE_KEY = 'minimalist_offline_notes';
        const SECRET_KEYWORD_KEY = 'app_secret_keyword'; 
        const APP_MODE_KEY = 'app_current_mode';
        const START_ITEMS_LIST_KEY = 'app_start_items';
        const END_ITEMS_LIST_KEY = 'app_end_items';
        const CUSTOM_ID_KEY = 'app_custom_id'; 
        
        const HALLUCINATION_TITLE_KEY = 'app_hallucination_title';
        const MIND_READING_TITLE_KEY = 'app_mind_reading_title';

        // --- DAFTAR ITEM DEFAULT ---
        const DEFAULT_START_ITEMS_20 = ["Koin", "Tisu", "Kunci", "Pensil", "Penghapus", "Jarum", "Gelas", "Batu", "Klip", "Benang", "Cap", "Topi", "Botol", "Daun", "Tanah", "Sisir", "Sekrup", "Kartu", "Obeng", "Kancing"];
        const DEFAULT_END_ITEMS_19 = ["Gelang", "Magnet", "Peniti", "Sandal", "Lampu", "Kabel", "Payung", "Buku", "Pulpen", "Meja", "Kursi", "Pintu", "Jendela", "Sepatu", "Rokok", "Korek", "Kertas", "Amplop", "Gunting"];
        
        const getInitialDefaultList = (key) => {
             if (key === START_ITEMS_LIST_KEY) return DEFAULT_START_ITEMS_20;
             if (key === END_ITEMS_LIST_KEY) return DEFAULT_END_ITEMS_19;
             return [];
        };

        // --- FUNGSI UTILITY PENYIMPANAN ---
        const getHallucinationTitle = () => localStorage.getItem(HALLUCINATION_TITLE_KEY) || 'List Benda Acak';
        const saveHallucinationTitle = (title) => localStorage.setItem(HALLUCINATION_TITLE_KEY, title.trim());
        const getMindReadingTitle = () => localStorage.getItem(MIND_READING_TITLE_KEY) || 'Clipboard Cepat';
        const saveMindReadingTitle = (title) => localStorage.setItem(MIND_READING_TITLE_KEY, title.trim());

        // --- GLOBAL STATE ---
        let appState = {
            notes: [],
            activeNoteId: null,
            title: '',
            content: '',
            isLoading: true,
            isSaving: false,
            secretKeyword: 'KUNCI',
            appMode: 'Hallucination', // 'Hallucination', 'MindReading', 'Normal'
            startItemsList: getInitialDefaultList(START_ITEMS_LIST_KEY),
            endItemsList: getInitialDefaultList(END_ITEMS_LIST_KEY),
            customId: '',
            hallucinationNoteTitle: getHallucinationTitle(),
            mindReadingNoteTitle: getMindReadingTitle(),
            rememberedItem: null,
            isListening: false,
            statusMessage: null, 
            longPressTimeout: null,
            originalTrickTitle: '', // Untuk menyimpan judul asli saat tap-hold
        };

        // --- FUNGSI UTILITY LOCAL STORAGE & UMUM ---

        const getLocalNotes = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Gagal memuat catatan dari Local Storage:", e);
                return [];
            }
        };

        const saveLocalNotes = (notes) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
            } catch (e) {
                console.error("Gagal menyimpan catatan ke Local Storage:", e);
            }
        };

        const getSecretKeyword = () => localStorage.getItem(SECRET_KEYWORD_KEY) || 'KUNCI';
        const saveSecretKeyword = (keyword) => localStorage.setItem(SECRET_KEYWORD_KEY, keyword.toUpperCase().trim());
        const getCustomId = () => localStorage.getItem(CUSTOM_ID_KEY) || '';
        const saveCustomId = (id) => localStorage.setItem(CUSTOM_ID_KEY, id.trim());
        const getAppMode = () => localStorage.getItem(APP_MODE_KEY) || 'Hallucination';
        const saveAppMode = (mode) => localStorage.setItem(APP_MODE_KEY, mode);
        
        const getItemsList = (key) => {
            try {
                const stored = localStorage.getItem(key);
                const parsed = stored ? JSON.parse(stored) : null;
                const defaultList = getInitialDefaultList(key);
                if (Array.isArray(parsed) && parsed.length > 0) return parsed;
                return defaultList;
            } catch (e) {
                console.error(`Gagal memuat daftar dari ${key}:`, e);
                return getInitialDefaultList(key);
            }
        };
        
        const saveItemsList = (key, list) => localStorage.setItem(key, JSON.stringify(list));
        const sortNotes = (notesArray) => [...notesArray].sort((a, b) => b.updatedAt - a.updatedAt);
        const isMatchingSecretKeyword = (title, keyword) => (title && keyword) ? title.toUpperCase().trim() === keyword.toUpperCase().trim() : false;
        const isTrickNote = (title, halluTitle, mrTitle) => title === halluTitle || title === mrTitle;
        
        const shuffleArray = (array) => {
            let newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const generateRandomListContent = (itemsList, isTriggered = false, isMindReading = false) => {
            if (!itemsList || itemsList.length === 0) return "ERROR: Daftar item tidak boleh kosong.";
            let listToDisplay;
            const N = itemsList.length;
            listToDisplay = [...itemsList];
            if (isMindReading) return listToDisplay.map((item, index) => `${index + 1}. ${item}`).join('\n');
            return listToDisplay.join('\n');
        };

        const initializeDiceDocument = async (id, showSuccess = false) => {
            if (!db || !/^\d{4}$/.test(id)) return;
            const docRef = doc(db, `dice/${id}`);
            try {
                await setDoc(docRef, { currentDiceNumber: 1, initializedAt: Date.now() }, { merge: false });
                console.log(`Firestore document 'dice/${id}' created successfully.`);
                if (showSuccess) showStatus(`ID Unik ${id} berhasil dibuat dan diaktifkan!`, false);
            } catch (e) {
                console.error("Gagal membuat dokumen Firestore dice:", e);
                showStatus(`Gagal membuat ID: ${e.message}`, true);
            }
        };

        const isCustomIdUnique = async (id) => {
            if (!db || !/^\d{4}$/.test(id)) return false;
            const docRef = doc(db, `dice/${id}`);
            try {
                const docSnap = await getDoc(docRef);
                return !docSnap.exists();
            } catch (e) {
                console.error("Gagal memeriksa keunikan Custom ID:", e);
                return false; 
            }
        };

        // --- STATE MANAGEMENT DAN RENDER UTAMA ---

        const setState = (newState) => {
            Object.assign(appState, newState);
            renderApp();
        };

        const showStatus = (message, isError = false) => {
            setState({ statusMessage: { message, isError } });
            setTimeout(() => setState({ statusMessage: null }), 4000); 
        };
        
        const handleLiveInput = (key, value) => {
            appState[key] = value; 
            if (key === 'title') {
                const trimmedTitle = value.trim().toUpperCase();
                if (trimmedTitle === appState.secretKeyword) {
                    checkSecretTitleTrigger(trimmedTitle);
                }
            }
        };

        const checkSecretTitleTrigger = (secretTitle) => {
            const existingSecretNote = appState.notes.find(n => isMatchingSecretKeyword(n.title, secretTitle));
            const currentContentInEditor = document.getElementById('content-editor')?.value || appState.content;

            if (existingSecretNote) {
                setState({ activeNoteId: existingSecretNote.id, title: existingSecretNote.title, content: existingSecretNote.content, rememberedItem: null });
            } else {
                const newNoteId = Date.now().toString();
                const timestamp = Date.now();
                const newSecretNote = { id: newNoteId, title: secretTitle, content: currentContentInEditor, createdAt: timestamp, updatedAt: timestamp };
                let updatedNotes = [newSecretNote, ...appState.notes.filter(note => note.id !== appState.activeNoteId && !isMatchingSecretKeyword(note.title, secretTitle))];
                saveLocalNotes(updatedNotes);
                setState({ notes: updatedNotes, activeNoteId: newNoteId, title: newSecretNote.title, content: newSecretNote.content, rememberedItem: null });
            }
        };

        // --- HANDLER UTAMA ---
        
        const handleOpenNote = (note) => setState({ activeNoteId: note.id, title: note.title, content: note.content, rememberedItem: null });

        const handleBackToList = () => {
            const isSecretNote = appState.activeNoteId && isMatchingSecretKeyword(appState.title, appState.secretKeyword);
            const isHallucinationNote = appState.appMode === 'Hallucination' && appState.title === appState.hallucinationNoteTitle;
            const isMindReadingNote = appState.appMode === 'MindReading' && appState.title === appState.mindReadingNoteTitle;
            
            if (!isSecretNote && (isHallucinationNote || isMindReadingNote)) {
                // Revert any changes to trick notes on back
                initApp(appState.appMode);
            }

            setState({ activeNoteId: null, title: '', content: '', rememberedItem: null });
        };

        const handleNewNote = () => setState({ activeNoteId: 'new', title: '', content: '', rememberedItem: null });

        const handleSaveNote = (internalCall = false) => {
            if (appState.isSaving && !internalCall) return;
            
            const editorTitleEl = document.getElementById('title-editor');
            const editorContentEl = document.getElementById('content-editor');
            if (editorTitleEl) appState.title = editorTitleEl.value;
            if (editorContentEl) appState.content = editorContentEl.value;

            const noteTitle = appState.title.trim() || 'Catatan Tanpa Judul';
            const noteContent = appState.content; 
            
            if (!noteTitle && !noteContent) {
                handleBackToList();
                return;
            }

            setState({ isSaving: true });
            const timestamp = Date.now();
            let updatedNotes;
            let newNoteId = appState.activeNoteId;
            const isSecretNoteBeingSaved = isMatchingSecretKeyword(noteTitle, appState.secretKeyword);
            let isNew = false;

            if (appState.activeNoteId && appState.activeNoteId !== 'new') {
                updatedNotes = appState.notes.map(note => note.id === appState.activeNoteId ? { ...note, title: noteTitle, content: noteContent, updatedAt: timestamp } : note);
            } else {
                isNew = true;
                newNoteId = timestamp.toString();
                const newNote = { id: newNoteId, title: noteTitle, content: noteContent, createdAt: timestamp, updatedAt: timestamp };
                updatedNotes = [newNote, ...appState.notes];
            }
            
            const finalNotes = sortNotes(updatedNotes);
            saveLocalNotes(finalNotes);
            setState({ notes: finalNotes, isSaving: false, activeNoteId: isNew ? newNoteId : appState.activeNoteId });
            
            if (!internalCall && !isSecretNoteBeingSaved) { 
                handleBackToList(); 
            }
        };

        const handleDeleteNote = () => {
            if (!appState.activeNoteId || appState.activeNoteId === 'new') return;
            const updatedNotes = appState.notes.filter(note => note.id !== appState.activeNoteId);
            saveLocalNotes(updatedNotes);
            setState({ notes: updatedNotes });
            handleBackToList();
        };

        const handleHallucinationTrigger = () => {
            document.getElementById('content-editor')?.blur();
            if (appState.appMode !== 'Hallucination' || appState.title !== appState.hallucinationNoteTitle) return;

            const expectedInitialContent = generateRandomListContent(appState.startItemsList, false, false);
            if (appState.content.trim() === expectedInitialContent.trim() && appState.endItemsList.length > 0) {
                const newContent = generateRandomListContent(appState.endItemsList, false, false); 
                appState.content = newContent; // Update state directly for instant feedback
                renderApp(); 
            }
        };
        
        // --- LOGIC MIND READING (TAP & HOLD) ---
        const longPressDuration = 500;

        const triggerMindReading = () => {
            document.getElementById('content-editor')?.blur();
            const newTitle = appState.rememberedItem || "Menunggu Item...";
            
            // Perbarui judul di DOM secara langsung untuk efek sementara
            const titleEditor = document.getElementById('title-editor');
            if(titleEditor) titleEditor.value = newTitle;
        };

        const startLongPress = () => {
            if (appState.appMode !== 'MindReading' || appState.title !== appState.mindReadingNoteTitle) return;
            
            // Simpan judul asli sebelum diubah
            const titleEditor = document.getElementById('title-editor');
            if (titleEditor) appState.originalTrickTitle = titleEditor.value;
            
            clearTimeout(appState.longPressTimeout);
            appState.longPressTimeout = setTimeout(triggerMindReading, longPressDuration);
        };

        const cancelLongPress = () => {
            clearTimeout(appState.longPressTimeout);
            
            // Kembalikan judul ke nilai aslinya setelah sentuhan dilepas
            const titleEditor = document.getElementById('title-editor');
            if (titleEditor && appState.originalTrickTitle) {
                titleEditor.value = appState.originalTrickTitle;
                appState.originalTrickTitle = ''; // Reset
            }
        };

        const handleCheckAndCreateId = async () => {
            const inputEl = document.getElementById('custom-id-input');
            if (!inputEl) return;
            const id = inputEl.value.trim();

            if (!/^\d{4}$/.test(id)) {
                showStatus("Custom ID harus 4 digit angka!", true);
                return;
            }
            if (!db) {
                showStatus("Koneksi Firebase tidak tersedia.", true);
                return;
            }

            setState({ isSaving: true });
            const isUnique = await isCustomIdUnique(id);
            if (isUnique) {
                await initializeDiceDocument(id, true);
                saveCustomId(id);
                appState.customId = id;
            } else {
                showStatus(`Custom ID ${id} sudah digunakan. Pilih angka lain.`, true);
            }
            setState({ isSaving: false });
        };
        
        // --- HANDLER SIMPAN PENGATURAN GLOBAL ---

        const handleSaveAllSettings = async (andExit = false) => {
            setState({ isSaving: true });
            
            let errorFound = false;
            
            // Ambil semua nilai dari DOM, gunakan optional chaining
            const newKeyword = document.getElementById('keyword-input')?.value.trim().toUpperCase();
            const customId = document.getElementById('custom-id-input')?.value.trim();
            const halluTitle = document.getElementById('hallucination-title-input')?.value.trim();
            const mrTitle = document.getElementById('mindreading-title-input')?.value.trim();
            const startListStr = document.getElementById('start-list-input')?.value;
            const endListStr = document.getElementById('end-list-input')?.value;

            // 1. Validasi & Simpan semua data tanpa terikat mode aktif
            if (newKeyword && (newKeyword === halluTitle?.toUpperCase() || newKeyword === mrTitle?.toUpperCase())) {
                showStatus("Keyword rahasia tidak boleh sama dengan judul trik!", true);
                errorFound = true;
            } else if (newKeyword) {
                saveSecretKeyword(newKeyword);
                appState.secretKeyword = newKeyword;
            }
            
            if (customId && !/^\d{4}$/.test(customId)) {
                showStatus("Custom ID harus 4 digit angka!", true);
                errorFound = true;
            } else if(customId) {
                // ID disimpan saat tombol "Buat ID" diklik, tidak di sini
            }

            if (halluTitle) {
                saveHallucinationTitle(halluTitle);
                appState.hallucinationNoteTitle = halluTitle;
            }
            if (mrTitle) {
                saveMindReadingTitle(mrTitle);
                appState.mindReadingNoteTitle = mrTitle;
            }

            if (startListStr !== undefined) {
                const startArray = startListStr.split('\n').map(item => item.trim()).filter(Boolean);
                saveItemsList(START_ITEMS_LIST_KEY, startArray);
                appState.startItemsList = startArray;
            }
             if (endListStr !== undefined) {
                const endArray = endListStr.split('\n').map(item => item.trim()).filter(Boolean);
                saveItemsList(END_ITEMS_LIST_KEY, endArray);
                appState.endItemsList = endArray;
            }

            // Finalisasi
            if (!errorFound) {
                await initApp(appState.appMode);
                if (andExit) {
                    handleBackToList();
                } else {
                    showStatus("Pengaturan berhasil disimpan!", false);
                }
            }
            setState({ isSaving: false });
        };


        // --- RENDER FUNCTIONS ---
        const renderNoteList = () => {
            const displayNotes = appState.notes.filter(note => !isMatchingSecretKeyword(note.title, appState.secretKeyword));
            const notesHtml = displayNotes.length === 0 ? `
                <p class="text-gray-500 text-center mt-10">Belum ada catatan. Tekan tombol '+' untuk membuat satu.</p>
            ` : displayNotes.map((note) => `
                <div 
                    id="note-${note.id}"
                    class="bg-white p-4 rounded-xl shadow-md cursor-pointer transition duration-200 border-l-4 border-indigo-400 note-item"
                    onclick="window.handleOpenNote({ id: '${note.id}', title: \`${note.title.replace(/`/g, '\\`')}\`, content: \`${note.content.replace(/`/g, '\\`')}\` })"
                >
                    <h2 class="text-lg font-semibold truncate text-black">${note.title || 'Catatan Tanpa Judul'}</h2>
                    <p class="text-sm text-gray-500 mt-1">${note.content ? (note.content.substring(0, 150).replace(/\n/g, ' ') + (note.content.length > 150 ? '...' : '')) : '...'}</p>
                    <span class="text-xs text-gray-400 mt-2 block">
                        Diperbarui: ${new Date(note.updatedAt || Date.now()).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' })}
                    </span>
                </div>
            `).join('');

            return `
                <div class="flex flex-col h-full bg-white p-4 light-theme">
                    <header class="mb-6 flex-shrink-0">
                        <h1 class="text-3xl font-bold text-black">Daftar Catatan</h1>
                    </header>
                    <div class="flex-grow overflow-y-auto space-y-3 pb-24">
                        ${notesHtml}
                    </div>
                    <button
                        onclick="window.handleNewNote()"
                        class="absolute bottom-6 right-6 p-4 bg-indigo-500 text-white rounded-full shadow-lg transition transform hover:scale-105 active:scale-95"
                    >
                        ${Icons.Plus.replace('dark-icon-filter', '')}
                    </button>
                </div>
            `;
        };
        
        const renderNoteEditor = () => {
            const isTrickNoteActive = (appState.appMode === 'Hallucination' && appState.title === appState.hallucinationNoteTitle) || (appState.appMode === 'MindReading' && appState.title === appState.mindReadingNoteTitle);
            const deleteButton = (appState.activeNoteId && appState.activeNoteId !== 'new') ? `
                <button onclick="window.handleDeleteNote()" class="p-2 text-red-500 transition rounded-full hover:bg-red-100">${Icons.Trash2}</button>
            ` : '';
            const saveButtonClass = appState.isSaving ? 'bg-gray-300 cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600';

            let extraAttributes = '';
            if (appState.appMode === 'Hallucination' && appState.title === appState.hallucinationNoteTitle) {
                extraAttributes = `onclick="window.handleHallucinationTrigger()"`;
            } else if (appState.appMode === 'MindReading' && appState.title === appState.mindReadingNoteTitle) {
                extraAttributes = `onmousedown="window.startLongPress(event)" onmouseup="window.cancelLongPress()" onmouseleave="window.cancelLongPress()" ontouchstart="window.startLongPress(event)" ontouchend="window.cancelLongPress()" ontouchcancel="window.cancelLongPress()"`;
            }

            return `
                <div class="flex flex-col h-full bg-white p-4 light-theme">
                    <header class="flex justify-between items-center mb-4 flex-shrink-0">
                        <button onclick="window.handleBackToList()" class="p-2 text-gray-700 transition rounded-full hover:bg-gray-100">${Icons.ArrowLeft}</button>
                        <div class="flex space-x-2">
                            ${deleteButton}
                            <button onclick="window.handleSaveNote(false)" ${appState.isSaving ? 'disabled' : ''} class="p-2 rounded-full text-white transition shadow-md ${saveButtonClass}">
                                ${appState.isSaving ? Icons.Loader2.replace('class="', 'class="animate-spin ') : Icons.Save.replace('dark-icon-filter', '')}
                            </button>
                        </div>
                    </header>
                    <input
                        id="title-editor" type="text" value="${appState.title}" oninput="window.handleLiveInput('title', this.value)"
                        placeholder="Judul Catatan" class="text-2xl font-semibold p-2 border-b-2 border-gray-100 mb-4 focus:border-indigo-500 outline-none w-full flex-shrink-0"
                        ${isTrickNoteActive ? 'readonly' : ''}
                    />
                    <textarea
                        id="content-editor" oninput="window.handleLiveInput('content', this.value)"
                        placeholder="Isi catatan Anda di sini..."
                        class="flex-grow w-full p-2 text-gray-800 resize-none outline-none leading-relaxed text-lg"
                        ${extraAttributes}
                    >${appState.content}</textarea>
                </div>
            `;
        };

        const renderSecretSettingsPanel = () => {
            const { secretKeyword, customId, statusMessage, appMode, startItemsList, endItemsList, isSaving, hallucinationNoteTitle, mindReadingNoteTitle } = appState;
            const statusHtml = statusMessage ? `<div class="p-3 rounded-lg font-semibold ${statusMessage.isError ? 'bg-red-700 text-white' : 'bg-green-600 text-white'}">${statusMessage.message}</div>` : '';
            
            const TitleEditor = (mode, currentTitle) => `
                <div class="mt-4">
                    <p class="text-sm font-light text-gray-400 mb-2">Judul Catatan Trik ${mode}:</p>
                    <input id="${mode.toLowerCase()}-title-input" type="text" value="${currentTitle}" placeholder="Judul Trik Baru"
                           class="w-full bg-gray-700 text-white p-3 rounded-lg outline-none focus:ring-2 focus:ring-red-500">
                </div>`;
            
            const ItemListForm = (type, list, title) => `
                <div class="bg-gray-700 p-4 rounded-lg shadow-inner flex flex-col mt-4">
                    <h3 class="text-md font-bold text-red-300 mb-2">${title}</h3>
                    <p class="text-xs font-light text-gray-400 mb-2">Pisahkan setiap item dengan baris baru. Jumlah saat ini: <span class="font-bold">${list.length}</span></p>
                    <textarea id="${type}-list-input" rows="8" class="bg-gray-800 text-gray-200 p-3 rounded-lg resize-none outline-none focus:ring-2 focus:ring-red-500 font-mono text-sm">${list.join('\n')}</textarea>
                </div>`;

            const saveButtonClass = isSaving ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600';

            return `
                <div class="flex flex-col h-full bg-gray-900 text-white p-4 font-sans secret-panel-container">
                    <header class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3 flex-shrink-0">
                        <button onclick="window.handleSaveAllSettings(false)" ${isSaving ? 'disabled' : ''} class="p-3 rounded-full transition shadow-md flex items-center ${saveButtonClass}">
                             ${isSaving ? Icons.Loader2.replace('class="', 'class="animate-spin w-5 h-5 ') : Icons.Save.replace('class="', 'class="w-5 h-5 ')}
                            <span class="ml-2 font-semibold hidden sm:inline">Simpan</span>
                        </button>
                        <h1 class="text-xl font-mono tracking-widest text-red-500 flex items-center">${Icons.Settings} PENGATURAN</h1>
                        <button onclick="window.handleSaveAllSettings(true)" class="p-3 rounded-full transition shadow-md bg-gray-700 text-red-400 hover:bg-red-500 hover:text-white">${Icons.ArrowLeft}</button>
                    </header>

                    <div class="flex-grow overflow-y-auto space-y-6 pb-6">
                        ${statusHtml}
                        <!-- Akses Rahasia -->
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl space-y-4">
                            <h2 class="text-lg font-bold text-indigo-400 flex items-center">${Icons.Unlock} Akses Rahasia</h2>
                            <div>
                                <p class="text-sm font-light text-gray-400 mb-2">Kata Kunci Pembuka Panel:</p>
                                <input id="keyword-input" type="text" value="${secretKeyword}" class="w-full bg-gray-700 text-white p-3 rounded-lg font-mono uppercase outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <p class="text-sm font-light text-gray-400 mb-2">Custom ID Firebase (4 Digit):</p>
                                <div class="flex space-x-2 items-center">
                                    <input id="custom-id-input" type="text" value="${customId}" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);" maxlength="4" placeholder="1234" class="w-24 bg-gray-700 text-white p-3 rounded-lg font-mono outline-none focus:ring-2 focus:ring-red-500">
                                    <button onclick="window.handleCheckAndCreateId()" class="p-3 bg-indigo-600 rounded-lg hover:bg-indigo-700 flex items-center space-x-2">
                                        ${isSaving ? Icons.Loader2.replace('class="', 'class="animate-spin w-5 h-5 ') : Icons.Check} <span>Buat ID</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Mode Operasi -->
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl">
                            <h2 class="text-lg font-bold text-indigo-400 mb-3 flex items-center">${Icons.Zap} Mode Operasi</h2>
                            <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-700 pb-4">
                                ${['Hallucination', 'MindReading', 'Normal'].map(mode => `
                                    <label class="flex items-center text-white cursor-pointer p-2 bg-gray-700 rounded-lg transition hover:bg-gray-600 ${appMode === mode ? 'ring-2 ring-red-500' : ''}">
                                        <input type="radio" name="appMode" value="${mode}" ${appMode === mode ? 'checked' : ''} ${mode === 'MindReading' && customId.length !== 4 ? 'disabled' : ''} onchange="window.handleModeChange(this.value)" class="mr-2">
                                        <span>${mode}</span>
                                        ${mode === 'MindReading' && customId.length !== 4 ? `<span class="text-xs text-yellow-400 ml-2">(Perlu ID)</span>` : ''}
                                    </label>
                                `).join('')}
                            </div>
                            ${TitleEditor('Hallucination', hallucinationNoteTitle)}
                            ${TitleEditor('MindReading', mindReadingNoteTitle)}
                        </div>
                        <!-- Kustomisasi Daftar -->
                        <div class="bg-gray-800 p-4 rounded-xl shadow-xl flex flex-col">
                           <h2 class="text-lg font-bold text-indigo-400 mb-2 flex items-center">${Icons.Edit} Kustomisasi Daftar</h2>
                           ${ItemListForm('start', startItemsList, 'Daftar Awal (Untuk Mind Reading & Hallucination)')}
                           ${ItemListForm('end', endItemsList, 'Daftar Akhir (Hanya untuk Hallucination)')}
                        </div>
                    </div>
                </div>
            `;
        };

        const handleModeChange = (newMode) => {
            if (newMode === 'MindReading' && appState.customId.length !== 4) {
                showStatus("Mind Reading membutuhkan Custom ID 4 digit. Harap atur dan buat ID terlebih dahulu.", true);
                return; 
            }
            saveAppMode(newMode);
            initApp(newMode);
            showStatus(`Mode diubah ke: ${newMode}`, false);
        };
        
        // --- FIREBASE LISTENER ---
        const setupMindReadingListener = () => {
            if (unsubscribeListener) unsubscribeListener();
            unsubscribeListener = null;

            const { appMode, customId } = appState;
            if (appMode !== 'MindReading' || !db || !customId || !/^\d{4}$/.test(customId)) {
                setState({ isListening: false });
                return; 
            }

            const docPath = `dice/${customId}`;
            console.log(`Mind Reading: Mulai mendengarkan di: ${docPath}`);
            setState({ isListening: true });

            unsubscribeListener = onSnapshot(doc(db, docPath), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const diceNumber = docSnapshot.data()?.currentDiceNumber;
                    if (typeof diceNumber !== 'number') return;
                    
                    const itemIndex = diceNumber - 1;
                    const list = appState.startItemsList; 
                    if (itemIndex >= 0 && itemIndex < list.length) {
                        const item = list[itemIndex];
                        appState.rememberedItem = item; // Update state directly
                        console.log(`Mind Reading: Item diingat (Nomor ${diceNumber}): ${item}`);
                    } else {
                        appState.rememberedItem = `[Nomor ${diceNumber} di luar jangkauan]`;
                    }
                } else {
                    console.warn(`Mind Reading: Dokumen dice/${customId} tidak ditemukan.`);
                }
            }, (error) => {
                console.error("Mind Reading Firestore Error:", error);
                setState({ isListening: false });
            });
        };

        // --- INIT APP ---
        const initApp = async (newMode = null) => {
            // Inisialisasi Firebase
            try {
                if (!auth) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                    console.log("Firebase signed in.");
                }
            } catch (e) { console.error("Gagal inisialisasi Firebase:", e); }

            // Muat Data & Tentukan Mode
            let currentMode = newMode || getAppMode();
            const initialCustomId = getCustomId();
            if (currentMode === 'MindReading' && initialCustomId.length !== 4) {
                currentMode = 'Normal';
                saveAppMode('Normal');
            }

            // Update appState dari Local Storage
            Object.assign(appState, {
                secretKeyword: getSecretKeyword(),
                appMode: currentMode,
                startItemsList: getItemsList(START_ITEMS_LIST_KEY),
                endItemsList: getItemsList(END_ITEMS_LIST_KEY),
                customId: initialCustomId,
                hallucinationNoteTitle: getHallucinationTitle(),
                mindReadingNoteTitle: getMindReadingTitle()
            });
            
            // Sinkronisasi Catatan Trik
            const allNotes = getLocalNotes();
            const nonTrickNotes = allNotes.filter(n => !isTrickNote(n.title, appState.hallucinationNoteTitle, appState.mindReadingNoteTitle));
            let finalNotes = nonTrickNotes;

            if (currentMode !== 'Normal') {
                const isMR = currentMode === 'MindReading';
                const trickTitle = isMR ? appState.mindReadingNoteTitle : appState.hallucinationNoteTitle;
                const initialContent = generateRandomListContent(appState.startItemsList, false, isMR);
                const trickNote = { 
                    id: `trick_note_${currentMode}`, 
                    title: trickTitle, 
                    content: initialContent, 
                    createdAt: Date.now(), 
                    updatedAt: Date.now() 
                };
                finalNotes.push(trickNote);
            }
            
            saveLocalNotes(finalNotes);
            setState({ notes: sortNotes(finalNotes), isLoading: false });
            setupMindReadingListener();
        };

        const renderApp = () => {
            const appDiv = document.getElementById('app');
            if (!appDiv) return;
            
            if (appState.isLoading) {
                 appDiv.innerHTML = `<div class="flex items-center justify-center h-full"><svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;
                 return;
            }

            const isSecretNote = appState.activeNoteId && isMatchingSecretKeyword(appState.title, appState.secretKeyword);
            
            if (appState.activeNoteId !== null) {
                appDiv.innerHTML = isSecretNote ? renderSecretSettingsPanel() : renderNoteEditor();
            } else {
                appDiv.innerHTML = renderNoteList();
            }
            
            // Expose Global functions
            window.handleOpenNote = handleOpenNote;
            window.handleBackToList = handleBackToList;
            window.handleNewNote = handleNewNote;
            window.handleSaveNote = handleSaveNote;
            window.handleDeleteNote = handleDeleteNote;
            window.handleHallucinationTrigger = handleHallucinationTrigger;
            window.handleModeChange = handleModeChange;
            window.handleSaveAllSettings = handleSaveAllSettings;
            window.handleLiveInput = handleLiveInput;
            window.startLongPress = startLongPress;
            window.cancelLongPress = cancelLongPress;
            window.handleCheckAndCreateId = handleCheckAndCreateId;
        };

        window.addEventListener('load', () => setTimeout(initApp, 300));

    </script>
</body>
</html>
